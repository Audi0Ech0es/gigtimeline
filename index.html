// components/Timeline.tsx
import React, { useEffect, useMemo, useState } from "react";
import { ScrollArea } from "@/components/ui/scroll-area";
import Papa from "papaparse";
import { CalendarDays, Music, MapPin, Globe } from "lucide-react";

const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTrfZfkmg5TVJmzhzn59YPXvQO-UXKJlC7zTUWo_MItM_tzINTt6aIOfj3-D7THX7Bw-uVBSUJ1Tgny/pub?gid=0&single=true&output=csv";

type Event = {
  date: string;
  venue: string;
  city: string;
  country: string;
};

const parseDate = (dateStr: string): Date => {
  const [day, month, year] = dateStr.split("/").map(Number);
  const date = new Date(year, month - 1, day);
  return isNaN(date.getTime()) ? new Date() : date;
};

const parseCSV = async (url: string): Promise<Event[]> => {
  const response = await fetch(url);
  if (!response.ok) throw new Error("CSV fetch failed");
  const csvText = await response.text();
  const parsed = Papa.parse(csvText, {
    header: true,
    skipEmptyLines: true,
    dynamicTyping: true,
  });

  return parsed.data
    .filter((row: any) =>
      row.Date &&
      row.Venue &&
      row.City &&
      row.Country &&
      !isNaN(parseDate(row.Date).getTime())
    )
    .map((row: any) => ({
      date: parseDate(row.Date).toISOString().slice(0, 10),
      venue: row.Venue,
      city: row.City,
      country: row.Country,
    }));
};

const groupByYear = (data: Event[]): Record<string, Event[]> => {
  const grouped = data.reduce((acc, event) => {
    const year = new Date(event.date).getFullYear().toString();
    if (!acc[year]) acc[year] = [];
    acc[year].push(event);
    return acc;
  }, {} as Record<string, Event[]>);

  Object.values(grouped).forEach((arr) =>
    arr.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())
  );

  return grouped;
};

const getUniqueCountries = (data: Event[]): string[] => {
  return Array.from(new Set(data.map((e) => e.country)));
};

const getUniqueYears = (data: Event[]): string[] => {
  return Array.from(new Set(data.map((e) => new Date(e.date).getFullYear().toString()))).sort();
};

const getFlagUrl = (() => {
  const cache: Record<string, string | null> = {};
  const isoMap: Record<string, string> = {
    "England": "gb",
    "Scotland": "gb",
    "Wales": "gb",
    "France": "fr",
    "United States of America": "us",
    "Netherlands": "nl",
    "Sweden": "se",
    "Ireland": "ie",
    "Northern Ireland": "gb",
    "Germany": "de",
    "Japan": "jp",
    "Canada": "ca",
    "Denmark": "dk",
    "Italy": "it",
    "Switzerland": "ch",
    "Spain": "es",
    "Belgium": "be",
    "Czech Republic": "cz",
    "Hong Kong China": "hk",
    "Australia": "au",
    "New Zealand": "nz",
    "Chile": "cl",
    "Argentina": "ar",
    "Brazil": "br",
    "Mexico": "mx",
    "Portugal": "pt",
    "Poland": "pl",
    "Finland": "fi",
    "Norway": "no",
    "Greece": "gr",
    "Hungary": "hu",
    "Venezuela": "ve",
    "Thailand": "th",
    "South Korea": "kr",
    "Singapore": "sg",
    "Taiwan": "tw",
    "South Africa": "za",
    "Peru": "pe"
  };

  return (country: string): string | null => {
    if (cache[country] !== undefined) return cache[country];
    const code = isoMap[country];
    return (cache[country] = code ? `https://flagcdn.com/w20/${code}.png` : null);
  };
})();

const formatFullDate = (iso: string): string => {
  return new Date(iso).toLocaleDateString(undefined, {
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};

const Timeline: React.FC = () => {
  const [events, setEvents] = useState<Event[]>([]);
  const [filterCountry, setFilterCountry] = useState("All");
  const [filterYear, setFilterYear] = useState("All");

  useEffect(() => {
    const fetchEvents = async () => {
      try {
        const data = await parseCSV(CSV_URL);
        setEvents(data);
      } catch (error) {
        console.error("Failed to load events:", error);
      }
    };
    fetchEvents();
  }, []);

  const filteredEvents = events.filter((e) => {
    const matchCountry = filterCountry === "All" || e.country === filterCountry;
    const matchYear = filterYear === "All" || new Date(e.date).getFullYear().toString() === filterYear;
    return matchCountry && matchYear;
  });

  const grouped = groupByYear(filteredEvents);
  const sortedYears = Object.keys(grouped).sort();
  const countries = useMemo(() => ["All", ...getUniqueCountries(events)], [events]);
  const years = useMemo(() => ["All", ...getUniqueYears(events)], [events]);

  return (
    <div className="h-[100vh] w-full flex flex-col bg-white text-black font-mono p-4">
      <div className="flex flex-wrap justify-center gap-4 mb-4">
        <div className="flex items-center gap-2">
          <Globe className="text-black" size={18} />
          <select
            className="border border-black px-4 py-1 text-sm uppercase"
            value={filterCountry}
            onChange={(e) => setFilterCountry(e.target.value)}
          >
            {countries.map((country) => (
              <option key={country} value={country}>
                {country}
              </option>
            ))}
          </select>
        </div>
        <div className="flex items-center gap-2">
          <CalendarDays className="text-black" size={18} />
          <select
            className="border border-black px-4 py-1 text-sm uppercase"
            value={filterYear}
            onChange={(e) => setFilterYear(e.target.value)}
          >
            {years.map((year) => (
              <option key={year} value={year}>
                {year}
              </option>
            ))}
          </select>
        </div>
      </div>

      <ScrollArea className="flex-1 w-full px-6">
        <div className="space-y-16 text-left text-black relative max-w-4xl mx-auto">
          {sortedYears.map((year) => (
            <div key={year} className="relative">
              <h2 className="text-2xl font-bold uppercase border-b border-black flex items-center gap-2 mb-4">
                <CalendarDays className="text-black" size={20} />
                {year}
              </h2>
              <div className="space-y-6">
                {grouped[year].map((event, idx) => {
                  const flagUrl = getFlagUrl(event.country);
                  return (
                    <div
                      key={idx}
                      className="text-sm uppercase font-medium tracking-wide flex-nowrap flex flex-row items-center gap-2 overflow-hidden hover:bg-gray-100 px-2 py-1 rounded"
                    >
                      <div className="flex items-center gap-1 whitespace-nowrap">
                        <Music size={14} className="text-black" />
                        <span className="font-bold">
                          {formatFullDate(event.date)}
                        </span>
                      </div>
                      <div className="truncate">
                        â€“ {event.venue}, {event.city} <MapPin size={12} className="inline text-black" />, {event.country}
                        {flagUrl && (
                          <img
                            src={flagUrl}
                            alt={event.country}
                            title={event.country}
                            className="w-4 h-3 inline-block ml-1"
                          />
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          ))}
        </div>
      </ScrollArea>
    </div>
  );
};

export default Timeline;
